{% extends "base.html" %}

{% block title %}WiFi Manager - Goat Guardian 360Â°{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow p-6 max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">WiFi Network Manager</h1>
    
    <div class="space-y-8">
        <!-- Current Connection -->
        <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
            <h2 class="text-lg font-semibold text-blue-800 mb-2">Current Connection</h2>
            <div class="flex items-center">
                <i data-feather="wifi" class="w-6 h-6 text-blue-600 mr-3"></i>
                <div>
                    <p class="font-medium" id="current-ssid">Not Connected</p>
                    <p class="text-sm text-gray-600" id="current-strength">Strength: --</p>
                </div>
                <button id="disconnect-btn" class="ml-auto text-sm text-red-600 hover:text-red-800">
                    Disconnect
                </button>
            </div>
        </div>

        <!-- Available Networks -->
        <div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Available Networks</h2>
            <div class="space-y-3" id="network-list">
                <!-- Skeleton awal -->
                <div class="animate-pulse bg-gray-100 rounded-lg p-4">
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                    <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                </div>
            </div>
        </div>

        <!-- Manual Connection -->
        <div class="border-t border-gray-200 pt-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Manual Connection</h2>
            <form id="wifi-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Network Name (SSID)</label>
                    <input type="text" id="ssid-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex space-x-4 pt-2">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <i data-feather="wifi" class="mr-2"></i> Connect
                    </button>
                    <button type="button" id="scan-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg flex items-center">
                        <i data-feather="refresh-cw" class="mr-2"></i> Scan Again
                    </button>
                </div>
            </form>
            <p class="text-xs text-gray-400 mt-2">
                Pastikan laptop & ESP32 berada di jaringan WiFi yang sama.
            </p>
        </div>
    </div>
</div>

<!-- Status Modal -->
<div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800" id="status-title">Connecting</h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="text-center py-4">
            <div class="inline-block mb-4">
                <span id="status-icon" data-feather="loader" class="w-12 h-12 text-blue-500 animate-spin"></span>
            </div>
            <p class="text-gray-700" id="status-message">Attempting to connect to network...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // GANTI dengan IP ESP dari Serial Monitor
    const ESP_BASE_URL = "http://192.168.1.5";

    function getStrengthColor(strength) {
        if (strength > 70) return 'green-500';
        if (strength > 40) return 'yellow-500';
        return 'red-500';
    }

    function renderNetworks(networks) {
        const networkList = document.getElementById('network-list');
        networkList.innerHTML = '';

        if (!networks || networks.length === 0) {
            networkList.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-100 text-yellow-800 rounded-lg p-3 text-sm">
                    Tidak ada jaringan terdeteksi. Coba klik "Scan Again" atau cek jarak ke router.
                </div>
            `;
            return;
        }

        networks.forEach(net => {
            const networkItem = document.createElement('div');
            networkItem.className = 'bg-gray-50 hover:bg-gray-100 rounded-lg p-4 transition cursor-pointer network-item';

            const strength = net.strength;
            const strengthColor = getStrengthColor(strength);

            networkItem.innerHTML = `
                <div class="flex items-center">
                    <i data-feather="${net.secured ? 'lock' : 'unlock'}"
                       class="w-5 h-5 ${net.secured ? 'text-green-500' : 'text-red-500'} mr-3"></i>
                    <div class="flex-1">
                        <p class="font-medium">${net.ssid}</p>
                        <div class="flex items-center mt-1">
                            <div class="w-24 mr-2">
                                <div class="h-1 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-${strengthColor}" style="width: ${strength}%"></div>
                                </div>
                            </div>
                            <span class="text-xs text-gray-500">${strength}%</span>
                        </div>
                    </div>
                </div>
            `;

            networkItem.addEventListener('click', () => {
                document.getElementById('ssid-input').value = net.ssid;
                document.getElementById('password-input').focus();
            });

            networkList.appendChild(networkItem);
        });

        feather.replace();
    }

    async function scanNetworks() {
        const networkList = document.getElementById('network-list');
        networkList.innerHTML = `
            <div class="animate-pulse bg-gray-100 rounded-lg p-4">
                <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-1/2"></div>
            </div>
        `;

        try {
            const res = await fetch(`${ESP_BASE_URL}/api/wifi/scan`);
            if (!res.ok) throw new Error('HTTP error ' + res.status);
            const networks = await res.json();
            renderNetworks(networks);
        } catch (err) {
            console.error(err);
            networkList.innerHTML = `
                <div class="bg-red-50 border border-red-100 text-red-800 rounded-lg p-3 text-sm">
                    Gagal memuat daftar jaringan dari ESP. Pastikan IP ESP benar dan satu jaringan.
                </div>
            `;
        }
    }

    async function loadStatus() {
        try {
            const res = await fetch(`${ESP_BASE_URL}/api/wifi/status`);
            if (!res.ok) throw new Error('HTTP error ' + res.status);
            const data = await res.json();

            if (data.connected) {
                document.getElementById('current-ssid').textContent = data.ssid;
                document.getElementById('current-strength').textContent =
                    data.rssi ? `Strength: ${data.rssi} dBm` : 'Strength: Good';
            } else {
                document.getElementById('current-ssid').textContent = 'Not Connected';
                document.getElementById('current-strength').textContent = 'Strength: --';
            }
        } catch (err) {
            console.error(err);
            document.getElementById('current-ssid').textContent = 'ESP Not Reachable';
            document.getElementById('current-strength').textContent = 'Strength: --';
        }
    }

    async function connectWiFi(ssid, password) {
        const res = await fetch(`${ESP_BASE_URL}/api/wifi/connect`, {
            method: 'POST',
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `ssid=${encodeURIComponent(ssid)}&password=${encodeURIComponent(password)}`
        });
        const result = await res.json();
        return result;
    }

    document.addEventListener('DOMContentLoaded', function () {
        feather.replace();

        const statusModal = document.getElementById('status-modal');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        const statusIcon = document.getElementById('status-icon');

        // Load awal
        loadStatus();
        scanNetworks();

        // Scan Again
        document.getElementById('scan-btn').addEventListener('click', function () {
            scanNetworks();
        });

        // Form Connect
        document.getElementById('wifi-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const ssid = document.getElementById('ssid-input').value;
            const password = document.getElementById('password-input').value;

            if (!ssid) {
                alert('SSID tidak boleh kosong');
                return;
            }

            statusTitle.textContent = 'Connecting';
            statusMessage.textContent = `Attempting to connect to ${ssid}...`;
            statusIcon.setAttribute('data-feather', 'loader');
            statusIcon.classList.add('animate-spin');
            feather.replace();

            statusModal.classList.remove('hidden');
            statusModal.classList.add('flex');

            try {
                const result = await connectWiFi(ssid, password);

                statusIcon.classList.remove('animate-spin');

                if (result.success) {
                    statusTitle.textContent = 'Connected!';
                    statusMessage.textContent = `Successfully connected to ${result.ssid} (IP: ${result.ip})`;
                    statusIcon.setAttribute('data-feather', 'check-circle');
                    feather.replace();

                    document.getElementById('current-ssid').textContent = result.ssid;
                    document.getElementById('current-strength').textContent = 'Strength: Good';

                    scanNetworks();
                    loadStatus();
                } else {
                    statusTitle.textContent = 'Connection Failed';
                    statusMessage.textContent = result.message || 'Could not connect to network. Please try again.';
                    statusIcon.setAttribute('data-feather', 'x-circle');
                    feather.replace();
                }
            } catch (err) {
                console.error(err);
                statusIcon.classList.remove('animate-spin');
                statusTitle.textContent = 'Error';
                statusMessage.textContent = 'Error communicating with ESP. Check IP & connection.';
                statusIcon.setAttribute('data-feather', 'alert-triangle');
                feather.replace();
            }
        });

        // Close modal
        document.getElementById('close-modal').addEventListener('click', function () {
            statusModal.classList.add('hidden');
            statusModal.classList.remove('flex');
        });

        // Dummy disconnect (belum kirim ke ESP)
        document.getElementById('disconnect-btn').addEventListener('click', function () {
            document.getElementById('current-ssid').textContent = 'Not Connected';
            document.getElementById('current-strength').textContent = 'Strength: --';
        });
    });
</script>
{% endblock %}

